{% extends 'base.html.twig' %}
{% block title %}Dashboard - Ticket Management{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/css/dashboard.css" />
<link href="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" rel="preload" as="script">
{% endblock %}

{% block content %}
<div class="dashboard-page">
  <header class="dashboard-header animated-fadeIn">
    <div class="container">
      <div class="header-content">
        <h1 class="dashboard-title animated-slideDown">Dashboard Overview</h1>
        <div class="header-actions">
          <a href="/tickets" class="quick-action-btn animated-bounce">+ New Ticket</a>
          <button type="button" class="logout-btn animated-pulse" onclick="openLogoutModal()">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <!-- ===== Ticket Statistics ===== -->
    <section class="stats-section animated-slideUp delay-1">
      <div class="container">
        <h2 class="section-title animated-fadeIn">Ticket Statistics</h2>
        <div class="stats-grid">
          <div class="stat-item" onclick="showToast('Total tickets: {{ stats.total }}')">
            <div class="stat-icon"><i data-lucide="bar-chart-2"></i></div>
            <h3>Total Tickets</h3>
            <p class="stat-number animated-zoomIn">{{ stats.total }}</p>
            <div class="stat-bar animated-fill"><div class="bar-fill" style="width:100%"></div></div>
          </div>

          <div class="stat-item" onclick="showToast('Open tickets: {{ stats.open }}')">
            <div class="stat-icon"><i data-lucide="alert-circle" style="color:#dc3545;"></i></div>
            <h3>Open Tickets</h3>
            <p class="stat-number animated-zoomIn" style="color:#dc3545;">{{ stats.open }}</p>
            <div class="stat-bar animated-fill">
              <div class="bar-fill open" style="width:{{ stats.total != 0 ? (stats.open / stats.total * 100)|round(1) : 0 }}%"></div>
            </div>
          </div>

          <div class="stat-item" onclick="showToast('In Progress: {{ stats.in_progress }}')">
            <div class="stat-icon"><i data-lucide="clock" style="color:#ffc107;"></i></div>
            <h3>In Progress</h3>
            <p class="stat-number animated-zoomIn" style="color:#ffc107;">{{ stats.in_progress }}</p>
            <div class="stat-bar animated-fill">
              <div class="bar-fill in_progress" style="width:{{ stats.total != 0 ? (stats.in_progress / stats.total * 100)|round(1) : 0 }}%"></div>
            </div>
          </div>

          <div class="stat-item" onclick="showToast('Closed: {{ stats.closed }}')">
            <div class="stat-icon"><i data-lucide="check-circle" style="color:#28a745;"></i></div>
            <h3>Closed Tickets</h3>
            <p class="stat-number animated-zoomIn" style="color:#28a745;">{{ stats.closed }}</p>
            <div class="stat-bar animated-fill">
              <div class="bar-fill closed" style="width:{{ stats.total != 0 ? (stats.closed / stats.total * 100)|round(1) : 0 }}%"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Recent Tickets ===== -->
    <section class="recent-tickets-section animated-slideUp delay-2">
      <div class="container">
        <h2 class="section-title animated-fadeIn">Recent Tickets</h2>
        <div class="tickets-table">
          <table class="tickets-table-header">
            <thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Assigned To</th><th>Date</th></tr></thead>
          </table>
          <div class="tickets-body">
            {% for ticket in recent_tickets %}
            <div class="ticket-row animated-slideLeft">
              <span class="ticket-cell">{{ ticket.id }}</span>
              <span class="ticket-cell title-cell">{{ ticket.title }}</span>
              <span class="ticket-cell status-cell {{ ticket.status }}">
                {{ ticket.status|replace({'_': ' '})|title }}
              </span>
              <span class="ticket-cell priority-cell {{ ticket.priority }}">
                {{ ticket.priority|title }}
              </span>
              <span class="ticket-cell">{{ ticket.assigned_to }}</span>
              <span class="ticket-cell">{{ ticket.date }}</span>
            </div>
            {% else %}
            <div class="ticket-row"><span class="ticket-cell" style="grid-column:1/-1;text-align:center;">No tickets yet.</span></div>
            {% endfor %}
          </div>
        </div>
        <div class="section-actions">
          <a href="/tickets" class="view-all-btn animated-bounce">View All Tickets</a>
        </div>
      </div>
    </section>

    <!-- ===== Quick Actions ===== -->
    <section class="quick-actions-section animated-slideUp delay-3">
      <div class="container">
        <h2 class="section-title animated-fadeIn">Quick Actions</h2>
        <div class="actions-grid">
          <a href="/tickets" class="action-card animated-rotateIn">
            <div class="action-icon"><i data-lucide="plus"></i></div>
            <h3>Create New Ticket</h3><p>Start a new ticket quickly</p>
          </a>
          <div class="action-card animated-rotateIn" onclick="showToast('Search feature coming soon!')">
            <div class="action-icon"><i data-lucide="search"></i></div>
            <h3>Search Tickets</h3><p>Find and filter tickets</p>
          </div>
          <div class="action-card animated-rotateIn" onclick="showToast('Assign feature coming soon!')">
            <div class="action-icon"><i data-lucide="users"></i></div>
            <h3>Assign Ticket</h3><p>Delegate tasks to team</p>
          </div>
          <div class="action-card animated-rotateIn" onclick="showToast('Report generation coming soon!')">
            <div class="action-icon"><i data-lucide="bar-chart"></i></div>
            <h3>Generate Report</h3><p>Export analytics</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== User Profile ===== -->
    <section class="user-profile-section animated-slideUp delay-4">
      <div class="container">
        <h2 class="section-title animated-fadeIn">User Profile</h2>
        <div class="profile-card animated-bounceIn">
          <div class="profile-avatar"><i data-lucide="user"></i></div>
          <h3 class="profile-name">Welcome, {{ profile.name|default('User') }}!</h3>
          <p class="profile-email">{{ profile.email|default('user@example.com') }}</p>
          <div class="profile-stats">
            <span class="profile-stat">Tickets Assigned: 0</span>
            <span class="profile-stat">Tickets Resolved: 0</span>
          </div>
          <button class="profile-btn animated-pulse" onclick="openProfileModal()">Edit Profile</button>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Logout Modal ===== -->
  <div id="logout-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content animated-bounceIn">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to log out?</p>
      <div class="modal-actions">
        <form method="POST" action="/logout" style="display:inline;">
          <button type="submit" class="modal-btn confirm">Yes, Logout</button>
        </form>
        <button type="button" class="modal-btn cancel" onclick="closeModal('logout-modal')">No</button>
      </div>
    </div>
  </div>

  <!-- ===== Profile Modal ===== -->
  <div id="profile-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content animated-bounceIn">
      <h3>Edit Profile</h3>
      <form method="POST" action="/dashboard/profile">
        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" value="{{ profile.name|default('') }}" placeholder="Enter your name" required />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" value="{{ profile.email|default('') }}" placeholder="Enter your email" required />
        </div>
        <div class="modal-actions">
          <button type="submit" class="modal-btn confirm">Save Changes</button>
          <button type="button" class="modal-btn cancel" onclick="closeModal('profile-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Decorative Elements -->

</div>

<script>
// Load Lucide Icons
lucide.createIcons();

// Toast
function showToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = `
    position:fixed;top:20px;left:50%;transform:translateX(-50%);
    background:#333;color:#fff;padding:12px 24px;border-radius:8px;
    z-index:10000;font-size:0.9rem;
    animation:fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Modal Controls
function openLogoutModal() {
  document.getElementById('logout-modal').style.display = 'flex';
}
// function openProfileModal() {
//   document.getElementById('profile-modal').style.display = 'flex';
// }
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

// Close modal on outside click
document.querySelectorAll('.modal-overlay').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal(modal.id);
  });
});
</script>

<style>
@keyframes fadeOut { to { opacity: 0; } }
@keyframes zoomIn { from { transform: scale(0.8); } to { transform: scale(1); } }
.animated-zoomIn { animation: zoomIn 0.6s ease-out; }

/* Fix ticket row grid */
.tickets-body { display: block; }
.ticket-row { display: grid; grid-template-columns: 1fr 3fr 1.5fr 1.2fr 1.5fr 1.2fr; gap: 0; }
.ticket-cell { border-right: 1px solid rgba(255,255,255,0.1); padding: 12px; }
.ticket-cell:last-child { border-right: none; }

/* Profile avatar */
.profile-avatar {
  width: 80px; height: 80px; margin: 0 auto 20px;
  border-radius: 50%; background: #007bff;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 32px;
}
</style>
{% endblock %}